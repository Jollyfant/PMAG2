<!DOCTYPE html>

<html lang="en">

  <head>

    <!-- Required metadata tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Paleomagnetism.org 2 - An online environment for paleomagnetic analysis">
    <meta name="keywords" content="paleomagnetism, interpretation, zijderveld, pca">

    <meta name="author" content="Mathijs Koymans">

    <link rel="stylesheet" href="./style.css">

    <!-- Bootstrap & Font Awesome CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
          crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css"
          integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz"
          crossorigin="anonymous">

  </head>

  <body>

    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">

      <a class="navbar-brand" href="#">Paleomagnetism.org</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        <ul class="navbar-nav mr-auto">

          <li class="nav-item">
            <a class="nav-link" href="./index.html">Interpretation</a>
          </li>
          <!--
          <li class="nav-item">
            <a class="nav-link" href="#">Statistics</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Tectonics</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Magnetostratigraphy</a>
          </li>
          -->
          <li class="nav-item active">
            <a class="nav-link" href="./pid">Search</a>
          </li>
        </ul>

        <form class="form-inline my-2 my-lg-0">
          <input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">
          <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Find Publication</button>
        </form>
      </div>

    </nav>

    <!-- Main container -->
    <div class="container">

      <div id="notification-container"></div>

       <div class="row">
	      <div class="col-md-2">
      <div class="card" style="width: auto;">
        <img class="card-img-top" src="./images/core.jpg" alt="Card image cap">
        <div class="card-body">
          <p class="card-text text-center text-muted"><b>Specimen</b></p>
        </div>
      </div>
      </div>
	      <div class="col-md-10">
            <table class="table table-sm table-striped table-responsive text-center">
              <tr>
                <td>Previous Specimen</td>
                <td>Next Specimen</td>
                <td>Previous Step</td>
                <td>Next Step</td>
                <td>Select Step</td>
                <td>Hide Step</td>
                <td>PCA (Direction)</td>
                <td>PCA (Plane)</td>
                <td>Anchor Component</td>
                <td>Cycle Projection</td>
                <td>Cycle Coordinates</td>
                <td>Fit Great Circles</td>

              </tr>
              <tr>
                <td>Left, A</td>
                <td>Right, D</td>
                <td>Up, W</td>
                <td>Down, S</td>
                <td>Plus, X</td>
                <td>Minus, Z</td>
                <td>1</td>
                <td>2</td>
                <td>Control</td>
                <td>3</td>
                <td>8</td>
                <td>9</td>
              <tr>

            </table>
	      </div>

	</div>

      <span id="table-header"></span>
      <hr>
      <table class='table table-sm table-striped' id="publication-table"></table>


	</div>

    <footer id='footer-container' class='container text-muted'></footer>

    <br> 

    <!-- Logo's -->
    <div class="justify-content-md-center text-center">
	  <div style="text-align: right; display: inline-block;">
	    <a href="http://www.geo.uu.nl/~forth/"><img style="margin: 0px; height: 60px;" src="./images/UU.png"></a>
        <a href="http://erc.europa.eu/"><img style="margin: 0px; height: 60px;" src="./images/ERC.png"></a>
	    <a href="http://www.nwo.nl/"><img style="margin: 0px; height: 60px;" src="./images/NWO_logo_plain.png"></a>
	  </div>
	</div>

    <br>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>

    <script src="./Coordinates.js"></script>
    <script src="./Direction.js"></script>
    <script src="./Direction.js"></script>
    <script src="./utils.js"></script>

  <script>

function FK() {

 HTTPRequest("./publications.json", "GET", function(json) {

  notify("success", "<i class='fas fa-check'></i> Succesfully loaded all digital objects and persistent identifiers.");


    var publications = JSON.parse(json);

    var rows = publications.map(function(x) {
      return "<td>" + x.author + "</td><td>" + x.description + "</td><td><code><a href='./pid.html?" + x.pid + "'>" + x.pid + "</a></code></td><td>" + x.created + "</td>";
    });

    document.getElementById("publication-table").innerHTML = [
      "<head>",
      "  <tr>",
      "    <th>Author</th>",
      "    <th>Description</th>",
      "    <th>Persistent Identifier (PID)</th>",
      "    <th>Created</th>",
      "  </tr>",
      "</head>",
    ].concat(rows).join("\n");
  
    resolvePID(publications[0].pid + "." + 0);

  });

  function resolvePID(pid) {

    var [pid, sample, interpretation] = pid.split(".");

    HTTPRequest("./publications/" + pid + ".pid", "GET", function(json) {

      var publication = JSON.parse(json);

      if(sample !== undefined) {
        var specimen = publication[Number(sample)];
        if(interpretation) {
          console.log(specimen.interpretations[interpretation])
        }
      }

    });

  }
}

if(window.location.search) {
  resolvePID(window.location.search.slice(1));
} else {
  FK();
}

function formatSpecimenTable(pid, publication, specimen) {

  /*
   * Function formatSpecimenTable
   * Formats the table containing all the specimens referenced by a particular PID
   */

  if(specimen.interpretations.length === 0) {
    return notify("warning", "No Interpretations available from PID: <b>" + pid + "</b>.");
  }

  notify("success", "Succesfully loaded specimen from publication with PID: <b>" + pid + "</b>.");

  document.getElementById("publication-table").innerHTML = [
    "<caption>Interpretations associated with this persistent identifier. <a href='./index.html?" + pid +"'><b>View in paleomagnetism.org</b></a>.",
    "<head>",
    "  <tr>",
    "    <th colspan='2'>Specimen</th>",
    "    <th colspan='2'>Geographic</th>",
    "    <th colspan='2'>Tectonic</th>",
    "    <th>MAD</th>",
    "    <th>Type</th>",
    "    <th>Steps</th>",
    "    <th>Anchored</th>",
    "    <th>Comment</th>",
    "    <th>Created</th>",
    "  </tr>",
    "</head>"
  ].concat(specimen.interpretations.map(formatInterpretationRows)).join("\n");

}

function formatInterpretationRows(sample, i) {

  // Convert x,y,z to coordinates
  var specimen = new Coordinates(sample.specimen.coordinates.x, sample.specimen.coordinates.y, sample.specimen.coordinates.z).toVector(Direction);
  var geographic = new Coordinates(sample.geographic.coordinates.x, sample.geographic.coordinates.y, sample.geographic.coordinates.z).toVector(Direction);
  var tectonic = new Coordinates(sample.tectonic.coordinates.x, sample.tectonic.coordinates.y, sample.tectonic.coordinates.z).toVector(Direction);

  return "<tr>" + new Array(
    specimen.dec.toFixed(2),
    specimen.inc.toFixed(2),
    geographic.dec.toFixed(2),
    geographic.inc.toFixed(2),
    tectonic.dec.toFixed(2),
    tectonic.inc.toFixed(2),
    sample.MAD.toFixed(2),
    sample.type,
    sample.steps.join(", "),
    sample.anchored,
    sample.comment,
    sample.created
  ).map(x => "<td>" + x + "</td>").join("\n") + "</tr>";
}

function formatPublicationTable(pid, publication) {

  /*
   * Function formatPublicationTable
   *
   */

  document.getElementById("table-header").innerHTML = "Specimens associated with this persistent identifier. <a href='./index.html?" + pid +"'><b>View in paleomagnetism.org</b></a>.";

  notify("success", "Succesfully loaded specimens with PID: <b>" + pid + "</b>.");

  document.getElementById("publication-table").innerHTML = [
    "<caption>Specimens available from " + pid + ". </caption>",
    "<head>",
    "  <tr>",
    "    <th>Sample</th>",
    "    <th>Core Azimuth</th>",
    "    <th>Core Dip</th>",
    "    <th>Bedding Strike</th>",
    "    <th>Bedding Dip</th>",
    "    <th>Longitude</th>",
    "    <th>Latitude</th>",
    "    <th>Type</th>",
    "    <th>Interpretations</th>",
    "    <th>Steps</th>",
    "    <th>Created</th>",
    "  </tr>",
    "</head>"
  ].concat(publication.map(formatSampleRows)).join("\n");

}

function formatSampleRows(sample, i) {

  if(sample.location) {
    var longitude = sample.location.lng;
    var latitude = sample.location.lat;
  } else {
    var longitude = "";
    var latitude = "";
  }

  return "<tr>" + new Array(
    "<a href='./pid.html" + window.location.search + "." + i + "'>" + sample.name + "</a>",
    sample.coreAzimuth,
    sample.coreDip,
    sample.beddingStrike,
    sample.beddingDip,
    longitude,
    latitude,
    sample.demagnetizationType || "",
    sample.interpretations.length,
    sample.steps.length,
    sample.created,
  ).map(x => "<td>" + x + "</td>").join("\n") + "</tr>";

}

  function resolvePID(pids) {

    var [pid, sample, interpretation] = pids.split(".");

    HTTPRequest("./publications/" + pid + ".pid", "GET", function(json) {

      var publication = JSON.parse(json).specimens;

      if(sample === undefined) {
        return formatPublicationTable(pids, publication);
      }

      var specimen = publication[Number(sample)];

      if(interpretation === undefined) {
        return formatSpecimenTable(pids, publication, specimen);
      }

      var interpret = specimen.interpretations[Number(interpretation)];

      console.log(interpret);

    });

  }

  </script>
  </body>
</html>
