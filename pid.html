<!DOCTYPE html>

<html lang="en">

  <head>

    <!-- Required metadata tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Paleomagnetism.org 2 - An online environment for paleomagnetic analysis">
    <meta name="keywords" content="paleomagnetism, interpretation, zijderveld, pca">

    <meta name="author" content="Mathijs Koymans">

    <link rel="stylesheet" href="./style.css">

    <!-- Bootstrap & Font Awesome CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
          crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css"
          integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz"
          crossorigin="anonymous">

  </head>

  <body>

    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">

      <a class="navbar-brand" href="#">Paleomagnetism.org</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        <ul class="navbar-nav mr-auto">

          <li class="nav-item">
            <a class="nav-link" href="./index.html">Interpretation</a>
          </li>
          <!--
          <li class="nav-item">
            <a class="nav-link" href="#">Statistics</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Tectonics</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Magnetostratigraphy</a>
          </li>
          -->
          <li class="nav-item active">
            <a class="nav-link" href="./pid">Search</a>
          </li>
        </ul>

        <form class="form-inline my-2 my-lg-0">
          <!--<input id="search-bar" class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">-->
          <a href="./pid.html" class="btn btn-sm btn-primary my-2 my-sm-0"><i class="fas fa-search"></i> <b>Search Objects</b></a>
        </form>

      </div>

    </nav>

    <!-- Main container -->
    <div class="container">

      <div id="notification-container"></div>

      <div class="row">
        <div class="col-lg-2">
          <div id="card-content" class="card" style="width: auto; max-width: 200px;"></div>
          <p>
       </div>
        
       <div class="col-md-10">
         <div style='float: right;' id="back-thing"></div>
         <h5> Digital Object Details <small><code><span id="pid-box"></span></code></small></h5>
         <div class="table-responsive">
           <table id="card-table" class="table text-center table-sm table-striped"></table>
	 </div>
       </div>

    </div>
    <div class="table-responsive">
      <table class='table table-sm text-center table-striped' id="publication-table"></table>
    </div>

    <footer id='footer-container' class='container text-muted'></footer>

    <br> 

    <!-- Logo's -->
    <div class="justify-content-md-center text-center">
      <div style="text-align: right; display: inline-block;">
        <a href="http://www.geo.uu.nl/~forth/"><img style="margin: 0px; height: 60px;" src="./images/UU.png"></a>
        <a href="http://erc.europa.eu/"><img style="margin: 0px; height: 60px;" src="./images/ERC.png"></a>
	<a href="http://www.nwo.nl/"><img style="margin: 0px; height: 60px;" src="./images/NWO_logo_plain.png"></a>
      </div>
    </div>

    <br>

    </body>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <script src="./Coordinates.js"></script>
    <script src="./Direction.js"></script>
    <script src="./utils.js"></script>

  <script>

function updateCardContent(type) {

  /*
   * Function updateCardContent
   * Updates the card content showing the type of the digital object
   */

  switch(type) {
    case "specimen":
      return [
        "<img id='object-image' class='card-img-top' src='./images/core.jpg' alt='Card image cap'>",
        "<div class='card-body'>",
        "  <p class='card-text text-center text-secondary'><b>Specimen</b></p>",
        "</div>",
      ].join("\n");
    case "collection":
      return [
        "<img id='object-image' class='card-img-top' src='./images/unknown.jpg' alt='Card image cap'>",
        "<div class='card-body'>",
        "  <p class='card-text text-center text-secondary'><b>Collection</b></p>",
        "</div>"
      ].join("\n");
    default:
      return [
        "<img id='object-image' class='card-img-top' src='./images/unknown.jpg' alt='Card image cap'>",
        "<div class='card-body'>",
        "  <p class='card-text text-center text-secondary'><b>Objects</b></p>",
        "</div>"
      ].join("\n");
  }

}

function loadDigitalObjectMetadata(pid, callback) {

  /*
   * Fuction loadDigitalObjectMetadata
   * Get the parent metadata object that describes this collection
   */

  HTTPRequest("publications.json", "GET", function(json) {
    callback(json.filter(x => pid === x.pid));
  });

}

function loadDigitalObjects() {

  /*
   * Function loadDigitalObjects
   * Loads all digital objects from disk
   */

  // Load the information from a JSON
  HTTPRequest("publications.json", "GET", function(publications) {

    var rows = publications.map(function(x) {
      return [
        "<tr>",
        "  <td>" + x.author + "</td>",
        "  <td>" + x.institution + "</td>",
        "  <td>" + x.description + "</td>",
        "  <td><code><a href='./pid.html?" + x.pid + "'>" + x.pid.slice(0, 16) + "â€¦</a></code></td>",
        "  <td>" + new Date(x.created).toISOString().slice(0, 10) + "</td>",
        "</tr>"
      ].join("\n");
    });

    document.getElementById("card-content").innerHTML = updateCardContent("objects");

    document.getElementById("publication-table").innerHTML = [
      "<head>",
      "  <tr>",
      "    <th>Author</th>",
      "    <th>Institution</th>",
      "    <th>Description</th>",
      "    <th>Persistent Identifier (PID)</th>",
      "    <th>Created</th>",
      "  </tr>",
      "</head>",
    ].concat(rows).join("\n");
  
    resolvePID(publications[0].pid + "." + 0);

  });

  function resolvePID(pid) {

    var [pid, sample, interpretation] = pid.split(".");

    HTTPRequest("publications/" + pid + ".pid", "GET", function(json) {

      var publication = JSON.parse(json);

      if(sample !== undefined) {
        var specimen = publication[Number(sample)];
        if(interpretation) {
          console.log(specimen.interpretations[interpretation])
        }
      }

    });

  }

}

function __init__() {

  // No search specified: show all digital objects
  if(!window.location.search) {
    return loadDigitalObjects();
  }

  // Attempt to resolve the persistent identifier
  resolvePID(window.location.search.slice(1));

}

__init__();

function updateCardTable(pid, pub, specimen) {

  /*
   * Function updateCardTable
   * Updates the upper table
   */

  return new Array(
    "<caption> Metadata associated with this specimen.</caption>",
    "<thead>",
    "  <tr>",
    "    <th>Sample</th>",
    "    <th>Reference</th>",
    "    <th>Longitude</th>",
    "    <th>Latitude</th>",
    "    <th>Type</th>",
    "    <th>Interpretations</th>",
    "    <th>Steps</th>",
    "    <th>Created</th>",
    "  </tr>",
    "</thead>",
    "<tbody>",
    "  <tr>",
    "    <td>" + specimen.name + " </td>",
    "    <td>" + (specimen.reference ? "YES" : "NO") + " </td>",
    "    <td>" + (specimen.location ? specimen.location.lng : '') + " </td>",
    "    <td>" + (specimen.location ? specimen.location.lat : '') + " </td>",
    "    <td>" + getDemagnetizationTypeLabel(specimen.demagnetizationType) + "</td>",
    "    <td>" + specimen.interpretations.length + "</td>",
    "    <td>" + specimen.steps.length + "</td>",
    "    <td>" + new Date(specimen.created).toISOString().slice(0, 10) + "</td>",
    "  </tr>",
    "</tbody>"
  ).join("\n");
  
}

function formatSpecimenTable(pid, publication, specimen) {

  /*
   * Function formatSpecimenTable
   * Formats the table containing all the specimens referenced by a particular PID
   */

  document.getElementById("card-content").innerHTML = updateCardContent("specimen");
  document.getElementById("card-table").innerHTML = updateCardTable(pid, publication, specimen);

  if(specimen.interpretations.length === 0) {
    return document.getElementById("publication-table").innerHTML = [
      "<caption>No interpretations available. <a href='./index.html?" + pid +"'><b>View in paleomagnetism.org</b></a>.</caption>"
    ].join("\n");
  }

  document.getElementById("publication-table").innerHTML = new Array(
    "<caption>Components associated with this persistent identifier. <a href='./index.html?" + pid +"'><b>View in paleomagnetism.org</b></a>.",
    "<head>",
    "  <tr>",
    "    <th colspan='2'>Specimen</th>",
    "    <th colspan='2'>Geographic</th>",
    "    <th colspan='2'>Tectonic</th>",
    "    <th>MAD</th>",
    "    <th>Type</th>",
    "    <th>Steps</th>",
    "    <th>Anchored</th>",
    "    <th>Comment</th>",
    "    <th>Created</th>",
    "  </tr>",
    "</head>"
  ).concat(specimen.interpretations.map(formatInterpretationRows)).join("\n");

}

function literalToCoordinates(coordinates) {

  /*
   * Function literalToCoordinates
   * Returns an object literal {x, y, z} to a Coordinate instance
   */

  return new Coordinates(coordinates.x, coordinates.y, coordinates.z);

}

function formatInterpretationRows(sample, i) {

  /*
   * Function formatInterpretationRows
   * Creates HTML for the component table
   */

  const PRECISION = 2;

  // Convert x,y,z to coordinates
  var specimen = literalToCoordinates(sample.specimen.coordinates).toVector(Direction);
  var geographic = literalToCoordinates(sample.geographic.coordinates).toVector(Direction);
  var tectonic = literalToCoordinates(sample.tectonic.coordinates).toVector(Direction);

  return "<tr>" + new Array(
    specimen.dec.toFixed(PRECISION),
    specimen.inc.toFixed(PRECISION),
    geographic.dec.toFixed(PRECISION),
    geographic.inc.toFixed(PRECISION),
    tectonic.dec.toFixed(PRECISION),
    tectonic.inc.toFixed(PRECISION),
    sample.MAD.toFixed(PRECISION),
    sample.type,
    "<small>" + sample.steps.join(", ") + "</small>",
    sample.anchored,
    sample.comment,
    new Date(sample.created).toISOString().slice(0, 10)
  ).map(x => "<td>" + x + "</td>").join("\n") + "</tr>";
}

function getDemagnetizationTypeLabel(type) {

  switch(type) {
    case "thermal":
      return "<i class='fas fa-fire text-danger'></i>";
    case "alternating":
      return "<i class='fas fa-bolt text-warning'></i>";
    default:
      return "<i class='fas fa-question text-success'></i>";
  }

}

function metadataContent(json) {

  /*
   * Function metadataContent
   * Fills upper table with metadata about the collection
   */

  // First element
  json = json.pop();

  return new Array(
    "<caption>Metadata associated with this collection.</caption>",
    "<thead>",
    "  <tr>",
    "    <th>Author</th>",
    "    <th>Description</th>",
    "    <th>Created</th>",
    "  </tr>",
    "</thead>", 
    "<tbody>",
    "  <tr>",
    "    <td>" + json.author + "</td>",
    "    <td>" + json.description + "</td>",
    "    <td>" + json.created + "</td>",
    "  </tr>",
    "</tbody>"
  ).join("\n");

}

function formatPublicationTable(pid, publication) {

  /*
   * Function formatPublicationTable
   *
   */

  loadDigitalObjectMetadata(pid, function(json) {
    document.getElementById("card-table").innerHTML = metadataContent(json);
  });

  document.getElementById("card-content").innerHTML = updateCardContent("collection");

  document.getElementById("publication-table").innerHTML = [
    "<caption>Specimens associated with this persistent identifier. <a href='./index.html?" + pid +"'><b>View in paleomagnetism.org</b></a>.",
    "<head>",
    "  <tr>",
    "    <th>Sample</th>",
    "    <th>Core Azimuth</th>",
    "    <th>Core Dip</th>",
    "    <th>Bedding Strike</th>",
    "    <th>Bedding Dip</th>",
    "    <th>Longitude</th>",
    "    <th>Latitude</th>",
    "    <th>Type</th>",
    "    <th>Components</th>",
    "    <th>Steps</th>",
    "    <th>Created</th>",
    "  </tr>",
    "</head>"
  ].concat(publication.map(formatSampleRows)).join("\n");

}

if(window.location.search) {

  /*
   * Add return button
   */

  var sp = window.location.search.split(".");

  if(sp.length === 1) {
    href = "./pid.html";
  } else {
    href = sp.slice(0, -1).join();
  }

  document.getElementById("back-thing").innerHTML = "<a href='" + href + "'><p><b><i class='fas fa-backward'></i>&nbsp; Return</b></a>";

}

function formatSampleRows(sample, i) {

  /*
   * Function formatSampleRows
   * Creates HTML for rows of the sample table
   */

  if(sample.location) {
    var longitude = sample.location.lng;
    var latitude = sample.location.lat;
  } else {
    var longitude = "";
    var latitude = "";
  }

  var name = sample.name;
  if(sample.reference) {
    name += "&nbsp; <a href='./pid.html?" + sample.reference + "'><i class='fas fa-code-branch'></i>";
  }

  return "<tr>" + new Array(
    "<a href='./pid.html" + window.location.search + "." + i + "'>" + name + "</a>",
    sample.coreAzimuth,
    sample.coreDip,
    sample.beddingStrike,
    sample.beddingDip,
    longitude,
    latitude,
    getDemagnetizationTypeLabel(sample.demagnetizationType),
    sample.interpretations.length,
    sample.steps.length,
    new Date(sample.created).toISOString().slice(0, 10),
  ).map(x => "<td>" + x + "</td>").join("\n") + "</tr>";

}

function resolvePID(pids) {

  /*
   * Function resolvePID
   * Resolves the persistent identifier
   */

  var [pid, sample, interpretation] = pids.split(".");

  // Show what pid is being resolved
  document.getElementById("pid-box").innerHTML = pids;

  HTTPRequest("publications/" + pid + ".pid", "GET", function(json) {

    var publication = json.specimens;

    if(sample === undefined) {
      return formatPublicationTable(pids, publication);
    }

    var specimen = publication[Number(sample)];

    if(interpretation === undefined) {
      return formatSpecimenTable(pids, publication, specimen);
    }

    var interpret = specimen.interpretations[Number(interpretation)];

    console.log(interpret);

  });

}

  </script>
</html>
